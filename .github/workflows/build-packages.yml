name: build-packages
on:
  push:
    # Prevents triggering multiple workflows in PRs. Workflows triggered from
    # the same commit shouldn't run simultaneously because they're overwriting
    # each other's packages on Anaconda.
    branches: [ master ]
    paths-ignore:
      - '.github/workflows/tuttest.yml'
      - 'README.md'
  pull_request:
    paths-ignore:
      - '.github/workflows/tuttest.yml'
      - 'README.md'
  workflow_dispatch:
  schedule:
    - cron: '0 23 * * *' # run daily at 23:00 (UTC)

env:
  ANACONDA_TOKEN: ${{ secrets.ANACONDA_TOKEN }}
  ANACONDA_USER: ${{ secrets.ANACONDA_USER }}
  NUM_OF_JOBS: 70

defaults:
  run:
    shell: bash

jobs:


  generate:
    runs-on: ubuntu-latest
    outputs:
      jobs: ${{ steps.jobs.outputs.jobs }}
    steps:
    - name: 'Generate jobs'
      id: jobs
      shell: python
      run: |
        jobs = [
          { 'PACKAGE': "bit/icestorm",                 'OS_NAME': "linux",   'RUNS_ON': "ubuntu-20.04" },   #2
          { 'PACKAGE': "bit/prjtrellis",               'OS_NAME': "linux",   'RUNS_ON': "ubuntu-20.04" },   #3
          { 'PACKAGE': "bit/prjoxide",                 'OS_NAME': "linux",   'RUNS_ON': "ubuntu-20.04" },   #4
          { 'PACKAGE': "bit/prjxray-db",               'OS_NAME': "linux",   'RUNS_ON': "ubuntu-20.04" },   #5
          { 'PACKAGE': "bit/prjxray-tools",            'OS_NAME': "linux",   'RUNS_ON': "ubuntu-20.04" },   #6
          { 'PACKAGE': "sim/icarus",                   'OS_NAME': "linux",   'RUNS_ON': "ubuntu-20.04" },   #7
          { 'PACKAGE': "sim/verilator",                'OS_NAME': "linux",   'RUNS_ON': "ubuntu-20.04" },   #8
          { 'PACKAGE': "syn/quicklogic-yosys",         'OS_NAME': "linux",   'RUNS_ON': "ubuntu-20.04" },   #13
          { 'PACKAGE': "syn/quicklogic-yosys-plugins", 'OS_NAME': "linux",   'RUNS_ON': "ubuntu-20.04" },   #14
          { 'PACKAGE': "pnr/vtr",                      'OS_NAME': "linux",   'RUNS_ON': "ubuntu-20.04" },   #16
          { 'PACKAGE': "pnr/vtr-gui",                  'OS_NAME': "linux",   'RUNS_ON': "ubuntu-20.04" },   #17
          { 'PACKAGE': "pnr/vtr-optimized",            'OS_NAME': "linux",   'RUNS_ON': "ubuntu-20.04" },   #18
          { 'PACKAGE': "pnr/symbiflow-vtr",            'OS_NAME': "linux",   'RUNS_ON': "ubuntu-20.04" },   #19
          { 'PACKAGE': "pnr/symbiflow-vtr-gui",        'OS_NAME': "linux",   'RUNS_ON': "ubuntu-20.04" },   #20
          { 'PACKAGE': "pnr/nextpnr/generic",          'OS_NAME': "linux",   'RUNS_ON': "ubuntu-20.04" },   #25
          { 'PACKAGE': "pnr/nextpnr/fpga_interchange", 'OS_NAME': "linux",   'RUNS_ON': "ubuntu-20.04" },   #27
          { 'PACKAGE': "bit/icestorm",                 'OS_NAME': "osx",     'RUNS_ON': "macos-latest" },   #31
          { 'PACKAGE': "bit/prjtrellis",               'OS_NAME': "osx",     'RUNS_ON': "macos-latest" },   #32
          { 'PACKAGE': "sim/icarus",                   'OS_NAME': "osx",     'RUNS_ON': "macos-latest" },   #33
          { 'PACKAGE': "sim/verilator",                'OS_NAME': "osx",     'RUNS_ON': "macos-latest" },   #34
          { 'PACKAGE': "pnr/nextpnr/generic",          'OS_NAME': "osx",     'RUNS_ON': "macos-latest" },   #42
          { 'PACKAGE': "bit/icestorm",                 'OS_NAME': "windows", 'RUNS_ON': "windows-latest" }, #43
          { 'PACKAGE': "sim/icarus",                   'OS_NAME': "windows", 'RUNS_ON': "windows-latest" }, #45
          { 'PACKAGE': "syn/yosys",                    'OS_NAME': "windows", 'RUNS_ON': "windows-latest" }, #46
          { 'PACKAGE': "syn/quicklogic-yosys",         'OS_NAME': "windows", 'RUNS_ON': "windows-latest" }, #47
          { 'PACKAGE': "misc/tree-sitter-verilog",     'OS_NAME': "linux",   'RUNS_ON': "ubuntu-20.04" },   #51
          { 'PACKAGE': "pnr/odin_II",                  'OS_NAME': "linux",   'RUNS_ON': "ubuntu-20.04" },   #52
          { 'PACKAGE': "sv-front/sv-parser",           'OS_NAME': "linux",   'RUNS_ON': "ubuntu-20.04" },   #54
          { 'PACKAGE': "misc/libunwind",               'OS_NAME': "linux",   'RUNS_ON': "ubuntu-20.04" },   #62
          { 'PACKAGE': "misc/netgen",                  'OS_NAME': "linux",   'RUNS_ON': "ubuntu-20.04" },   #66
          { 'PACKAGE': "sv-front/zachjs-sv2v",         'OS_NAME': "linux",   'RUNS_ON': "ubuntu-20.04" },   #67
          { 'PACKAGE': "pnr/openroad",                 'OS_NAME': "linux",   'RUNS_ON': "ubuntu-20.04" },   #69
          # uses older ubuntu for better compat:
          # https://github.com/hdl/conda-eda/issues/199
          { 'PACKAGE': "hls/xls",                      'OS_NAME': "linux",   'RUNS_ON': "ubuntu-18.04" },   #70
        ]
        print(f'::set-output name=jobs::{jobs!s}')

  matrix:
    needs: generate
    strategy:
      fail-fast: false
      matrix:
        include: ${{ fromJson(needs.generate.outputs.jobs) }}
    name: '${{ matrix.PACKAGE }} | ${{ matrix.OS_NAME }}'
    runs-on: ${{ matrix.RUNS_ON }}
    env:
      PACKAGE: ${{ matrix.PACKAGE }}
      OS_NAME: ${{ matrix.OS_NAME }}
    steps:
      - uses: actions/checkout@v2
      - uses: hdl/conda-ci@master

  #1
  magic-linux:
    runs-on: "ubuntu-20.04"
    env:
      PACKAGE: "misc/magic"
      OS_NAME: "linux"
    steps:
      - uses: actions/checkout@v2
      - name: 'Install csh'
        run: |
          sudo apt update
          sudo apt install -y csh
      - uses: hdl/conda-ci@master

  #9
  yosys-linux-py37:
    runs-on: "ubuntu-20.04"
    env:
      PACKAGE: "syn/yosys"
      OS_NAME: "linux"
      PYTHON_VERSION: "3.7"
    steps:
      - uses: actions/checkout@v2
      - uses: hdl/conda-ci@master

  #10
  yosys-linux-py38:
    runs-on: "ubuntu-20.04"
    env:
      PACKAGE: "syn/yosys"
      OS_NAME: "linux"
      PYTHON_VERSION: "3.8"
    steps:
      - uses: actions/checkout@v2
      - uses: hdl/conda-ci@master

  #11
  yosys-plugins-symbiflow-linux:
    runs-on: "ubuntu-20.04"
    needs: ["matrix", "yosys-linux-py37", "yosys-linux-py38", "surelog-linux-py37", "surelog-linux-py38"]
    env:
      PACKAGE: "syn/yosys-plugins-symbiflow"
      OS_NAME: "linux"
    steps:
      - uses: actions/checkout@v2
      - uses: hdl/conda-ci@master

  #12
  nextpnr-nexus-linux:
    runs-on: "ubuntu-20.04"
    needs: "matrix"
    env:
      PACKAGE: "pnr/nextpnr/nexus"
      OS_NAME: "linux"
    steps:
      - uses: actions/checkout@v2
      - uses: hdl/conda-ci@master

  #15
  symbiflow-yosys-plugins-linux:
    runs-on: "ubuntu-20.04"
    needs: ["matrix", "yosys-linux-py37", "yosys-linux-py38", "surelog-linux-py37", "surelog-linux-py38"]
    env:
      PACKAGE: "syn/symbiflow-yosys-plugins"
      OS_NAME: "linux"
    steps:
      - uses: actions/checkout@v2
      - uses: hdl/conda-ci@master

  #21
  quicklogic-vtr-linux:
    runs-on: "ubuntu-20.04"
    needs: "matrix"
    env:
      PACKAGE: "pnr/quicklogic-vtr"
      OS_NAME: "linux"
    steps:
      # Skip if token isn't available (cross-repository PRs mainly)
      - run: if [ "$ANACONDA_TOKEN" = "" ]; then echo "SKIP=true" >>$GITHUB_ENV; fi
      - uses: actions/checkout@v2
      - uses: hdl/conda-ci@master

  #22
  quicklogic-vtr-gui-linux:
    runs-on: "ubuntu-20.04"
    needs: "matrix"
    env:
      PACKAGE: "pnr/quicklogic-vtr-gui"
      OS_NAME: "linux"
    steps:
      # Skip if token isn't available (cross-repository PRs mainly)
      - run: if [ "$ANACONDA_TOKEN" = "" ]; then echo "SKIP=true" >>$GITHUB_ENV; fi
      - uses: actions/checkout@v2
      - uses: hdl/conda-ci@master

  #23
  nextpnr-ice40-linux:
    runs-on: "ubuntu-20.04"
    needs: "matrix"
    env:
      PACKAGE: "pnr/nextpnr/ice40"
      OS_NAME: "linux"
    steps:
      - uses: actions/checkout@v2
      - uses: hdl/conda-ci@master

  #24
  nextpnr-ecp5-linux:
    runs-on: "ubuntu-20.04"
    needs: "matrix"
    env:
      PACKAGE: "pnr/nextpnr/ecp5"
      OS_NAME: "linux"
    steps:
      - uses: actions/checkout@v2
      - uses: hdl/conda-ci@master

  #26
  nextpnr-xilinx-linux:
    runs-on: "ubuntu-20.04"
    env:
      PACKAGE: "pnr/nextpnr/xilinx"
      OS_NAME: "linux"
      KEEP_ALIVE: "true"
      USE_PYPY: "1"
      SKIP: "true"  # See https://github.com/hdl/conda-eda/issues/191
    steps:
      - uses: actions/checkout@v2
      - name: 'Install pypy'
        run: |
          sudo add-apt-repository ppa:pypy/ppa -y
          sudo apt update
          sudo apt install -y pypy3
      - uses: hdl/conda-ci@master

  #28
  symbiyosys-linux-py37:
    runs-on: "ubuntu-20.04"
    needs: "yosys-linux-py37"
    env:
      PACKAGE: "formal/symbiyosys"
      OS_NAME: "linux"
      PYTHON_VERSION: "3.7"
      SKIP: "true"  # See https://github.com/litex-hub/litex-conda-eda/issues/70
    steps:
      - uses: actions/checkout@v2
      - uses: hdl/conda-ci@master

  #29
  symbiyosys-linux-py38:
    runs-on: "ubuntu-20.04"
    needs: "yosys-linux-py38"
    env:
      PACKAGE: "formal/symbiyosys"
      OS_NAME: "linux"
      PYTHON_VERSION: "3.8"
      SKIP: "true"  # See https://github.com/litex-hub/litex-conda-eda/issues/70
    steps:
      - uses: actions/checkout@v2
      - uses: hdl/conda-ci@master

  #30
  xilinx-vivado-linux:
    runs-on: "ubuntu-20.04"
    env:
      PACKAGE: "xilinx/vivado"
      OS_NAME: "linux"
      VERSIONS: ${{ format('{0}{1}', github.workspace, '/xilinx/vivado/versions') }}
      SCRIPT: ${{ format('{0}{1}', github.workspace, '/xilinx/vivado/gen_metapackages.sh') }}
    steps:
      - uses: actions/checkout@v2
      - uses: hdl/conda-ci@master

  #35
  yosys-osx:
    runs-on: "macos-latest"
    env:
      PACKAGE: "syn/yosys"
      OS_NAME: "osx"
      EXTRA_BUILD_ARGS: "--no-test"
    steps:
      - uses: actions/checkout@v2
      - uses: hdl/conda-ci@master

  #36
  quicklogic-yosys-osx:
    runs-on: "macos-latest"
    env:
      PACKAGE: "syn/quicklogic-yosys"
      OS_NAME: "osx"
      EXTRA_BUILD_ARGS: "--no-test"
    steps:
      - uses: actions/checkout@v2
      - uses: hdl/conda-ci@master

  #37
  quicklogic-yosys-plugins-osx:
    runs-on: "macos-latest"
    needs: ["matrix", "quicklogic-yosys-osx"]
    env:
      PACKAGE: "syn/quicklogic-yosys-plugins"
      OS_NAME: "osx"
    steps:
      - uses: actions/checkout@v2
      - uses: hdl/conda-ci@master

  #38
  symbiflow-yosys-plugins-osx:
    runs-on: "macos-latest"
    needs: ["matrix", "yosys-osx"]
    env:
      PACKAGE: "syn/symbiflow-yosys-plugins"
      OS_NAME: "osx"
      SKIP: "true"  # See https://github.com/litex-hub/litex-conda-eda/issues/71
    steps:
      - uses: actions/checkout@v2
      - uses: hdl/conda-ci@master

  #39
  vtr-osx:
    runs-on: "macos-latest"
    env:
      PACKAGE: "pnr/vtr"
      OS_NAME: "osx"
      SKIP: "true"
    steps:
      - uses: actions/checkout@v2
      - uses: hdl/conda-ci@master

  #40
  vtr-gui-osx:
    runs-on: "macos-latest"
    env:
      PACKAGE: "pnr/vtr-gui"
      OS_NAME: "osx"
      SKIP: "true"
    steps:
      - uses: actions/checkout@v2
      - uses: hdl/conda-ci@master

  #41
  nextpnr-ice40-osx:
    runs-on: "macos-latest"
    needs: "matrix"
    env:
      PACKAGE: "pnr/nextpnr/ice40"
      OS_NAME: "osx"
    steps:
      - uses: actions/checkout@v2
      - uses: hdl/conda-ci@master

  #44
  prjtrellis-windows:
    runs-on: "windows-latest"
    env:
      PACKAGE: "bit/prjtrellis"
      OS_NAME: "windows"
      SKIP: "true"  # See: https://github.com/hdl/conda-eda/issues/201
    steps:
      - uses: actions/checkout@v2
      - uses: hdl/conda-ci@master

  #48
  nextpnr-ice40-windows:
    runs-on: "windows-latest"
    needs: "matrix"
    env:
      PACKAGE: "pnr/nextpnr/ice40"
      OS_NAME: "windows"
      SKIP: "true"  # See: https://github.com/hdl/conda-eda/issues/120
    steps:
      - uses: actions/checkout@v2
      - uses: hdl/conda-ci@master

  #49
  nextpnr-generic-windows:
    runs-on: "windows-latest"
    env:
      PACKAGE: "pnr/nextpnr/generic"
      OS_NAME: "windows"
      SKIP: "true"  # See: https://github.com/hdl/conda-eda/issues/120
    steps:
      - uses: actions/checkout@v2
      - uses: hdl/conda-ci@master

  #50
  verible-linux:
    runs-on: "ubuntu-20.04"
    env:
      PACKAGE: "sv-front/verible"
      USE_SYSTEM_GCC_VERSION: "9"
      OS_NAME: "linux"
    steps:
      - uses: actions/checkout@v2
      - uses: hdl/conda-ci@master

  #53
  slang-linux:
    runs-on: "ubuntu-20.04"
    env:
      PACKAGE: "sv-front/slang"
      OS_NAME: "linux"
      USE_SYSTEM_GCC_VERSION: "9"
    steps:
      - uses: actions/checkout@v2
      - uses: hdl/conda-ci@master

  #55
  moore-linux:
    runs-on: "ubuntu-20.04"
    env:
      PACKAGE: "sv-front/moore"
      OS_NAME: "linux"
      SKIP: "true"  # See https://github.com/hdl/conda-eda/issues/163
    steps:
      - uses: actions/checkout@v2
      - uses: hdl/conda-ci@master

  #56
  surelog-linux-py37:
    needs: ["matrix", "gperftools"]
    runs-on: "ubuntu-20.04"
    env:
      PACKAGE: "sv-front/surelog"
      OS_NAME: "linux"
      PYTHON_VERSION: "3.7"
    steps:
      - uses: actions/checkout@v2
      - uses: hdl/conda-ci@master

  #57
  surelog-linux-py38:
    needs: ["matrix", "gperftools"]
    runs-on: "ubuntu-20.04"
    env:
      PACKAGE: "sv-front/surelog"
      OS_NAME: "linux"
      PYTHON_VERSION: "3.8"
    steps:
      - uses: actions/checkout@v2
      - uses: hdl/conda-ci@master

  #58
  surelog-uhdm-linux-py37:
    needs: ["matrix", "gperftools"]
    runs-on: "ubuntu-20.04"
    env:
      PACKAGE: "sv-front/surelog-uhdm"
      USE_SYSTEM_GCC_VERSION: "9"
      OS_NAME: "linux"
      PYTHON_VERSION: "3.7"
    steps:
      - uses: actions/checkout@v2
      - uses: hdl/conda-ci@master

  #59
  surelog-uhdm-linux-py38:
    needs: ["matrix", "gperftools"]
    runs-on: "ubuntu-20.04"
    env:
      PACKAGE: "sv-front/surelog-uhdm"
      USE_SYSTEM_GCC_VERSION: "9"
      OS_NAME: "linux"
      PYTHON_VERSION: "3.8"
    steps:
      - uses: actions/checkout@v2
      - uses: hdl/conda-ci@master

  #60
  yosys-uhdm-linux-py37:
    needs: ["matrix", "gperftools"]
    runs-on: "ubuntu-20.04"
    env:
      PACKAGE: "syn/yosys-uhdm"
      OS_NAME: "linux"
      PYTHON_VERSION: "3.7"
    steps:
      - uses: actions/checkout@v2
      - uses: hdl/conda-ci@master

  #61
  yosys-uhdm-linux-py38:
    needs: ["matrix", "gperftools"]
    runs-on: "ubuntu-20.04"
    env:
      PACKAGE: "syn/yosys-uhdm"
      OS_NAME: "linux"
      PYTHON_VERSION: "3.8"
    steps:
      - uses: actions/checkout@v2
      - uses: hdl/conda-ci@master

  #63
  gperftools:
    needs: "matrix"
    runs-on: "ubuntu-20.04"
    env:
      PACKAGE: "misc/gperftools"
      OS_NAME: "linux"
    steps:
      - uses: actions/checkout@v2
      - uses: hdl/conda-ci@master

  #64
  verilator-uhdm-linux-py37:
    needs: "gperftools"
    runs-on: "ubuntu-20.04"
    env:
      PACKAGE: "sim/verilator-uhdm"
      OS_NAME: "linux"
      PYTHON_VERSION: "3.7"
    steps:
      - uses: actions/checkout@v2
      - uses: hdl/conda-ci@master

  #65
  verilator-uhdm-linux-py38:
    needs: "gperftools"
    runs-on: "ubuntu-20.04"
    env:
      PACKAGE: "sim/verilator-uhdm"
      OS_NAME: "linux"
      PYTHON_VERSION: "3.8"
    steps:
      - uses: actions/checkout@v2
      - uses: hdl/conda-ci@master

  #68
  open_pdks-linux:
    runs-on: "ubuntu-20.04"
    needs: "magic-linux"
    env:
      PACKAGE: "misc/open_pdks"
      OS_NAME: "linux"
    steps:
      - uses: actions/checkout@v2
      - uses: hdl/conda-ci@master

  master-package:
    runs-on: "ubuntu-20.04"
    env:
      OS_NAME: "linux"
      CI_SCRIPTS_REL_PATH: "conda-ci"
    steps:
      - uses: actions/checkout@v2
      - uses: actions/checkout@v2
        with:
          repository: hdl/conda-ci
          ref: master
          path: ${{ env.CI_SCRIPTS_REL_PATH }}
      - uses: actions/setup-python@v1
      - uses: BSFishy/pip-action@v1
        with:
          packages: urllib3
      - run: |
          # Required internally by the scripts to locate other scripts.
          export CI_SCRIPTS_PATH="$GITHUB_WORKSPACE/$CI_SCRIPTS_REL_PATH"
          bash $CI_SCRIPTS_PATH/install.sh
          python $CI_SCRIPTS_PATH/wait-for-statuses.py
